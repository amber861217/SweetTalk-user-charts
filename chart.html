<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>User Sugar Intake Chart</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
      #stacked_chart_div, #pie_chart_div {
        text-align: center;
      }
    </style>
    <script>
      google.charts.load('current', { packages: ['corechart'] });

      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }

      function drawCharts(userData) {
        // 準備多條長條圖資料
        const dates = [...new Set(userData.map(row => row.Date))].sort();
        const categories = ['甜點', '鹹點', '飲料', '原型食物'];
        const userDSIG = userData.length > 0 ? parseFloat(userData[0].UserDSIG) : 0;

        // 多條長條圖資料表
        const chartData = new google.visualization.DataTable();
        chartData.addColumn('string', 'Date');
        categories.forEach(category => {
          chartData.addColumn('number', category);
        });
        chartData.addColumn({ type: 'number', role: 'annotation' }); // 總和註解

        const sugarByDateCategory = dates.map(date => {
          const row = [date];
          let totalSugar = 0;
          categories.forEach(category => {
            const sugarSum = userData
              .filter(d => d.Date === date && d.Category === category)
              .reduce((sum, d) => sum + parseFloat(d.Sugar || 0), 0);
            totalSugar += sugarSum;
            row.push(sugarSum);
          });
          row.push(totalSugar); // 總和作為註解
          return row;
        });

        chartData.addRows(sugarByDateCategory);

        // 多條長條圖選項
        const chartOptions = {
          title: '每日含糖量攝取（按類別）',
          titleTextStyle: {
            fontSize: 18,
            bold: true
          },
          hAxis: { title: 'Date' },
          vAxis: { 
            title: 'Sugar (grams)',
            titleTextStyle: { fontSize: 14 },
            viewWindow: { min: 0 },
            baseline: userDSIG, // 設置 User DSIG 常數線
            baselineColor: 'red',
            annotations: {
              textStyle: { color: 'red', fontSize: 12 }
            }
          },
          colors: ['#FF7575', '#81C0C0', '#FFD700', '#90EE90'], // 甜點、鹹點、飲料、原型食物
          legend: { position: 'top' },
          width: 800,
          height: 500,
          isStacked: false // 移除堆疊
        };

        // 繪製多條長條圖
        const chart = new google.visualization.ColumnChart(document.getElementById('stacked_chart_div'));
        chart.draw(chartData, chartOptions);

        // 準備圓餅圖資料
        const categoryCounts = categories.map(category => {
          const sugarSum = userData
            .filter(d => d.Category === category)
            .reduce((sum, d) => sum + parseFloat(d.Sugar || 0), 0);
          return [category, sugarSum];
        });

        const pieData = new google.visualization.DataTable();
        pieData.addColumn('string', 'Category');
        pieData.addColumn('number', 'Sugar (grams)');
        pieData.addRows(categoryCounts);

        // 圓餅圖選項
        const pieOptions = {
          title: '含糖量按類別占比',
          titleTextStyle: {
            fontSize: 18,
            bold: true
          },
          colors: ['#FF7575', '#81C0C0', '#FFD700', '#90EE90'],
          width: 500,
          height: 400
        };

        // 繪製圓餅圖
        const pieChart = new google.visualization.PieChart(document.getElementById('pie_chart_div'));
        pieChart.draw(pieData, pieOptions);
      }

      async function fetchData(userId) {
        const sheetId = '14rbVT-gGHLdYV3Sf_YjpRZ8YoZSTtXIIMrCYr7Arjb0';
        const sheetName = 'Template';
        const query = encodeURIComponent('SELECT A, B, C, D, E, F, G, H, I');
        const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tq=${query}`;

        const response = await fetch(url);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));

        const rows = json.table.rows.map(r => ({
          UserID: r.c[0]?.v,
          Date: r.c[1]?.f || r.c[1]?.v,
          Time: r.c[2]?.v,
          SnackName: r.c[3]?.v,
          Category: r.c[4]?.v,
          Size: r.c[5]?.v,
          Sugar: r.c[6]?.v,
          UploadMethod: r.c[7]?.v,
          UserDSIG: r.c[8]?.v
        }));

        const filteredData = rows.filter(r => r.UserID === userId);
        if (filteredData.length === 0) {
          document.getElementById('stacked_chart_div').innerHTML = `<p>No data found for ${userId}</p>`;
          document.getElementById('pie_chart_div').innerHTML = '';
        } else {
          drawCharts(filteredData);
        }
      }

      google.charts.setOnLoadCallback(() => {
        const userId = getQueryParam('userid');
        if (userId) {
          fetchData(userId);
        } else {
          document.getElementById('stacked_chart_div').innerHTML = '<p>No user ID provided in URL</p>';
          document.getElementById('pie_chart_div').innerHTML = '';
        }
      });
    </script>
  </head>
  <body>
    <h2>User Sugar Intake Chart</h2>
    <div id="stacked_chart_div" style="width: 900px; height: 500px;"></div>
    <div id="pie_chart_div" style="width: 500px; height: 400px; margin: 0 auto;"></div>
  </body>
</html>
